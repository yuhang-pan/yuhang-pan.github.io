<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>China Carbon Market – Province MACC Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <style>
    :root { --border:#ddd; --muted:#666; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      margin: 24px;
      max-width: 1500px;
      line-height: 1.35;
    }
    h1{ margin: 0 0 6px 0; }
    p{ margin: 6px 0 0 0; color:#444; }

    .panel{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0 18px 0;
    }

    /* -------- table -------- */
    .table-wrap{
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
      background: white;
    }
    thead th{
      position: sticky;
      top: 0;
      background: #fafafa;
      z-index: 1;
    }
    th, td{
      border-bottom: 1px solid var(--border);
      padding: 10px;
      font-size: 14px;
      text-align: left;
      vertical-align: middle;
    }
    tbody tr:hover{ background: #fcfcfc; }
    th small{ color: var(--muted); font-weight: 500; }

    .num input{
      width: 120px;
      padding: 6px 8px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }

    /* -------- controls -------- */
    .controls{
      display: grid;
      grid-template-columns: 240px 1fr 240px 1fr;
      gap: 10px 16px;
      align-items: center;
    }
    .controls input, .controls select, button{
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    button{
      cursor: pointer;
      background: white;
      border-color: #bbb;
      width: fit-content;
    }
    button.primary{
      border-color:#111;
      font-weight: 650;
    }

    /* -------- plots -------- */
    .plots{
      display: grid;
      gap: 14px;
    }
    .plot-card{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: white;
    }
    .plot-title{
      display:flex;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .plot-meta{
      font-size: 12.5px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .plot{
      height: 240px;
      width: 100%;
    }

    footer{
      margin-top: 18px;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>

<body>

<h1>Province MACC Dashboard (China)</h1>
<p>
Edit parameters in the table. MACC plots update automatically.
<b>Sigma</b> and <b>x (externality impact)</b> are stored but not plotted.
</p>

<!-- GLOBAL SETTINGS -->
<div class="panel">
  <h2 style="margin:0 0 10px 0;">Global settings</h2>
  <div class="controls">
    <label>Max abatement (x-axis)</label>
    <input id="amax" type="number" value="100" step="1"/>

    <label>Number of points</label>
    <input id="npts" type="number" value="80" step="1"/>

    <label>Provinces per row</label>
    <select id="cols">
      <option value="3">3</option>
      <option value="4" selected>4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>

    <label>Y-axis scale</label>
    <select id="sameY">
      <option value="auto" selected>Auto (province)</option>
      <option value="common">Common (all provinces)</option>
    </select>
  </div>

  <div style="margin-top:12px; display:flex; gap:10px;">
    <button class="primary" id="renderAll">Render / Refresh all</button>
    <button id="resetAll">Reset all to defaults</button>
  </div>
</div>

<!-- PARAMETER TABLE -->
<div class="panel">
  <h2 style="margin:0 0 10px 0;">Province parameters</h2>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Province</th>
          <th>Intercept<br><small>MAC at x=0</small></th>
          <th>Slope<br><small>per unit abatement</small></th>
          <th>Sigma<br><small>stored</small></th>
          <th>x (Externality)<br><small>stored</small></th>
        </tr>
      </thead>
      <tbody id="paramBody"></tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2 style="margin:0 0 10px 0;">Aggregate welfare loss</h2>
  <p style="margin-top:4px;">
    The bar chart compares welfare loss under the
    <em>Plan</em> scenario (σ<sub>i</sub>) and the
    <em>Market</em> scenario (x<sub>i</sub>).
  </p>

  <button id="calcW">Compute welfare</button>

  <div id="wBar" style="height:260px; max-width:520px; margin-top:10px;"></div>
  <div id="wResult" style="margin-top:8px; font-size:14px;"></div>
</div>

<h2>MACC plots</h2>
<div id="plots" class="plots"></div>

<footer>
  © Yuhang Pan · GitHub Pages · Plotly.js
</footer>

<script>
/* ---------- DATA ---------- */
const PROVINCES = [
  "Beijing","Tianjin","Hebei","Shanxi","Inner Mongolia",
  "Liaoning","Jilin","Heilongjiang",
  "Shanghai","Jiangsu","Zhejiang","Anhui","Fujian","Jiangxi","Shandong",
  "Henan","Hubei","Hunan","Guangdong","Guangxi","Hainan",
  "Chongqing","Sichuan","Guizhou","Yunnan",
  "Shaanxi","Gansu","Qinghai","Ningxia","Xinjiang"
];

const DEFAULT = { intercept:0, slope:1, sigma:5, x:0 };
const state = new Map();

/* ---------- HELPERS ---------- */
const $ = id => document.getElementById(id);
const linspace = (a,b,n)=>Array.from({length:n},(_,i)=>a+i*(b-a)/(n-1));

function ensureState(){
  PROVINCES.forEach(p=>{
    if(!state.has(p)) state.set(p,{...DEFAULT});
  });
}

/* ---------- TABLE ---------- */
function buildTable(){
  const tbody = $("paramBody");
  tbody.innerHTML = "";

  PROVINCES.forEach(p=>{
    const v = state.get(p);
    const id = p.replace(/\s+/g,"-").toLowerCase();

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${p}</b></td>
      <td class="num"><input type="number" step="0.1" value="${v.intercept}" data-p="${p}" data-k="intercept"></td>
      <td class="num"><input type="number" step="0.1" value="${v.slope}" data-p="${p}" data-k="slope"></td>
      <td class="num"><input type="number" step="0.1" value="${v.sigma}" data-p="${p}" data-k="sigma"></td>
      <td class="num"><input type="number" step="0.1" value="${v.x}" data-p="${p}" data-k="x"></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.oninput = e=>{
    const el = e.target;
    if(!el.dataset.p) return;
    const v = state.get(el.dataset.p);
    v[el.dataset.k] = Number(el.value);
    renderProvince(el.dataset.p);
    if($("sameY").value==="common") renderAll();
  };
}

/* ---------- PLOTS ---------- */
function computeCommonY(){
  const amax = +$("amax").value;
  const npts = +$("npts").value;
  let ymin=Infinity, ymax=-Infinity;

  PROVINCES.forEach(p=>{
    const v = state.get(p);
    linspace(0,amax,npts).forEach(x=>{
      const y = v.intercept + v.slope*x;
      ymin=Math.min(ymin,y);
      ymax=Math.max(ymax,y);
    });
  });
  const pad = 0.05*(ymax-ymin||1);
  return [ymin-pad,ymax+pad];
}

function renderProvince(p, commonY=null){
  const v = state.get(p);
  const id = p.replace(/\s+/g,"-").toLowerCase();
  const amax = +$("amax").value;
  const npts = +$("npts").value;

  const x = linspace(0,amax,npts);
  const y = x.map(xx=>v.intercept+v.slope*xx);

  document.getElementById(`meta-${id}`).textContent =
    `a=${v.intercept}, b=${v.slope}, σ=${v.sigma}, x=${v.x}`;

  const layout = {
    margin:{t:18,l:44,r:10,b:34},
    xaxis:{title:"Abatement", tickfont:{size:11}},
    yaxis:{title:"MAC", tickfont:{size:11}},
    showlegend:false
  };
  if(commonY) layout.yaxis.range = commonY;

  Plotly.newPlot(`plot-${id}`,[{x,y,type:"scatter",mode:"lines",line:{width:2}}],layout,
    {responsive:true, displayModeBar:false});
}

function renderAll(){
  $("plots").style.gridTemplateColumns =
    `repeat(${$("cols").value}, minmax(220px,1fr))`;

  const commonY = $("sameY").value==="common" ? computeCommonY() : null;
  PROVINCES.forEach(p=>renderProvince(p, commonY));
}

/* ---------- INIT ---------- */
ensureState();
buildTable();

// build plot cards
$("plots").innerHTML = "";
PROVINCES.forEach(p=>{
  const id = p.replace(/\s+/g,"-").toLowerCase();
  const div = document.createElement("div");
  div.className="plot-card";
  div.innerHTML = `
    <div class="plot-title">${p}</div>
    <div class="plot-meta" id="meta-${id}"></div>
    <div id="plot-${id}" class="plot"></div>
  `;
  $("plots").appendChild(div);
});

renderAll();

function computeWelfare() {

  const slopes = [];
  const sigmas = [];
  const xs = [];

  for (const prov of PROVINCES) {
    const v = state.get(prov);
    const c = v.slope;
    const s = v.sigma;
    const x = v.x;

    if (c > 0 && Number.isFinite(c)) {
      slopes.push(c);
      sigmas.push(Number.isFinite(s) ? s : 0);
      xs.push(Number.isFinite(x) ? x : 0);
    }
  }

  const N = slopes.length;
  if (N === 0) {
    $("wResult").textContent =
      "Cannot compute: no province with positive slope.";
    Plotly.purge("wBar");
    return;
  }

  // weights
  const invC = slopes.map(c => 1 / c);
  const S = invC.reduce((a,b)=>a+b,0);
  const w = invC.map(v => v / S);

  // --- Plan welfare ---
  let Vtheta = 0;
  for (let i = 0; i < N; i++) {
    Vtheta += w[i] * (1 - w[i]) * sigmas[i] * sigmas[i];
  }
  const deltaWPlan = 0.5 * S * Vtheta;

  // --- Market welfare ---
  let xbar = 0;
  for (let i = 0; i < N; i++) xbar += w[i] * xs[i];

  let Dx = 0;
  for (let i = 0; i < N; i++) {
    const d = xs[i] - xbar;
    Dx += w[i] * d * d;
  }
  const deltaWMarket = 0.5 * S * Dx;

  // --- bar chart ---
  Plotly.newPlot("wBar", [{
    x: ["Plan","Market"],
    y: [deltaWPlan, deltaWMarket],
    type: "bar",
    text: [deltaWPlan, deltaWMarket].map(v => v.toFixed(3)),
    textposition: "outside"
  }], {
    margin:{t:30,r:10,b:40,l:60},
    yaxis:{title:"Welfare loss"},
  }, {displayModeBar:false});

  // --- display text summary ---
  $("wResult").innerHTML =
    `Provinces used: ${N}<br>` +
    `S = ${S.toFixed(4)}, V\u03B8 = ${Vtheta.toFixed(4)}, ` +
    `D<sub>x</sub> = ${Dx.toFixed(4)}<br>` +
    `ΔW<sup>Plan</sup> ≈ <b>${deltaWPlan.toFixed(4)}</b>, ` +
    `ΔW<sup>Market</sup> ≈ <b>${deltaWMarket.toFixed(4)}</b>`;
}

/* ---------- EVENTS ---------- */
["amax","npts","cols","sameY"].forEach(id=>{
  $(id).addEventListener("change", renderAll);
});
$("renderAll").onclick = renderAll;
$("resetAll").onclick = ()=>{
  state.clear();
  ensureState();
  buildTable();
  renderAll();
};

$("calcW").onclick = computeWelfare;

</script>





</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>China Carbon Market – Province MACC Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <style>
    :root { --border:#ddd; --muted:#666; }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
      margin: 24px;
      max-width: 1500px;
      line-height: 1.35;
    }
    h1{ margin: 0 0 6px 0; }
    p{ margin: 6px 0 0 0; color:#444; }

    .panel{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0 18px 0;
    }

    /* -------- table -------- */
    .table-wrap{
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
      background: white;
    }
    thead th{
      position: sticky;
      top: 0;
      background: #fafafa;
      z-index: 1;
    }
    th, td{
      border-bottom: 1px solid var(--border);
      padding: 10px;
      font-size: 14px;
      text-align: left;
      vertical-align: middle;
    }
    tbody tr:hover{ background: #fcfcfc; }
    th small{ color: var(--muted); font-weight: 500; }

    .num input{
      width: 120px;
      padding: 6px 8px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }

    /* -------- controls -------- */
    .controls{
      display: grid;
      grid-template-columns: 240px 1fr 240px 1fr;
      gap: 10px 16px;
      align-items: center;
    }
    .controls input, .controls select, button{
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    button{
      cursor: pointer;
      background: white;
      border-color: #bbb;
      width: fit-content;
    }
    button.primary{
      border-color:#111;
      font-weight: 650;
    }

    /* -------- plots -------- */
    .plots{
      display: grid;
      gap: 14px;
    }
    .plot-card{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: white;
    }
    .plot-title{
      display:flex;
      justify-content: space-between;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .plot-meta{
      font-size: 12.5px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .plot{
      height: 240px;
      width: 100%;
    }

    footer{
      margin-top: 18px;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>

<body>

<h1>Province MACC Dashboard (China)</h1>
<p>
Edit parameters in the table. MACC plots update automatically.
<b>Sigma</b> and <b>x (externality impact)</b> are stored but not plotted.
</p>

<!-- GLOBAL SETTINGS -->
<div class="panel">
  <h2 style="margin:0 0 10px 0;">Global settings</h2>
  <div class="controls">
    <label>Max abatement (x-axis)</label>
    <input id="amax" type="number" value="100" step="1"/>

    <label>Number of points</label>
    <input id="npts" type="number" value="80" step="1"/>

    <label>Provinces per row</label>
    <select id="cols">
      <option value="3">3</option>
      <option value="4" selected>4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>

    <label>Y-axis scale</label>
    <select id="sameY">
      <option value="auto" selected>Auto (province)</option>
      <option value="common">Common (all provinces)</option>
    </select>
  </div>

  <div style="margin-top:12px; display:flex; gap:10px;">
    <button class="primary" id="renderAll">Render / Refresh all</button>
    <button id="resetAll">Reset all to defaults</button>
  </div>
</div>

<!-- PARAMETER TABLE -->
<div class="panel">
  <h2 style="margin:0 0 10px 0;">Province parameters</h2>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Province</th>
          <th>Intercept<br><small>MAC at x=0</small></th>
          <th>Slope<br><small>per unit abatement</small></th>
          <th>Sigma<br><small>stored</small></th>
          <th>x (Externality)<br><small>stored</small></th>
        </tr>
      </thead>
      <tbody id="paramBody"></tbody>
    </table>
  </div>
</div>

<div class="panel">
  <h2 style="margin:0 0 10px 0;">Aggregate welfare loss</h2>
  <p style="margin-top:4px;">
    The bar chart compares welfare loss under the
    <em>Plan</em> scenario (σ<sub>i</sub>) and the
    <em>Market</em> scenario (x<sub>i</sub>).
  </p>

  <button id="calcW">Compute welfare</button>

  <div id="wBar" style="height:260px; max-width:520px; margin-top:10px;"></div>
  <div id="wResult" style="margin-top:8px; font-size:14px;"></div>
</div>

<h2>MACC plots</h2>
<div id="plots" class="plots"></div>

<footer>
  © Yuhang Pan · GitHub Pages · Plotly.js
</footer>

<script>
/* ---------- DATA ---------- */
const PROVINCES = [
  "Beijing","Tianjin","Hebei","Shanxi","Inner Mongolia",
  "Liaoning","Jilin","Heilongjiang",
  "Shanghai","Jiangsu","Zhejiang","Anhui","Fujian","Jiangxi","Shandong",
  "Henan","Hubei","Hunan","Guangdong","Guangxi","Hainan",
  "Chongqing","Sichuan","Guizhou","Yunnan",
  "Shaanxi","Gansu","Qinghai","Ningxia","Xinjiang"
];

const DEFAULTS = {
  "Ningxia":        { intercept: 0.0969173, slope: 388.7702, sigma: 11.22568, x: 8.462444 },
  "Fujian":         { intercept: 1.728792,  slope: 364.0056, sigma: 22.26661, x: 46.1823 },
  "Henan":          { intercept: 1.496045,  slope: 123.0015, sigma: 93.32495, x: 94.28677 },
  "Guangxi":        { intercept: 1.338495,  slope: 563.3428, sigma: 21.49690, x: 37.56079 },
  "Yunnan":         { intercept: 3.955799,  slope: 384.8373, sigma: 52.56854, x: 38.02209 },
  "Jiangsu":        { intercept: 0.2859142, slope: 251.0002, sigma: 18.41771, x: 80.89072 },
  "Hainan":         { intercept: 0.6471579, slope: 462.3269, sigma: 5.113141, x: 10.25463 },
  "Hubei":          { intercept: 1.093514,  slope: 295.0746, sigma: 42.91271, x: 88.60152 },
  "Shandong":       { intercept: 0.5592239, slope: 263.8553, sigma: 28.84925, x: 36.29885 },
  "Sichuan":        { intercept: 0.8150355, slope: 381.5338, sigma: 5.629647, x: 90.56181 },
  "Tianjin":        { intercept: 3.979701,  slope: 456.1849, sigma: 21.93646, x: 56.25079 },
  "Gansu":          { intercept: 0.4718419, slope: 410.8334, sigma: 9.100637, x: 25.20455 },
  "Hebei":          { intercept: 0.7405924, slope: 300.8457, sigma: 5.774339, x: 45.84569 },
  "Hunan":          { intercept: 0.9044383, slope: 388.124,  sigma: 5.655239, x: 111.783 },
  "Heilongjiang":   { intercept: 0.8373291, slope: 336.4144, sigma: 9.651719, x: 17.74529 },
  "Shanxi":         { intercept: 0.2508018, slope: 174.4202, sigma: 27.94556, x: 6.610334 },
  "Jiangxi":        { intercept: 0.571995,  slope: 413.7971, sigma: 3.081146, x: 78.97498 },
  "Shanghai":       { intercept: 4.087292,  slope: 448.4839, sigma: 37.00269, x: 69.0893 },
  "Guizhou":        { intercept: 0.6300412, slope: 347.6277, sigma: 3.452188, x: 21.58498 },
  "Zhejiang":       { intercept: 0.7460558, slope: 334.93,   sigma: 36.70445, x: 49.31145 },
  "Inner Mongolia": { intercept: 0.1640011, slope: 256.6075, sigma: 49.08710, x: 7.037306 },
  "Beijing":        { intercept: 7.530193,  slope: 530.3611, sigma: 27.72600, x: 122.1807 },
  "Xinjiang":       { intercept: 0.1610102, slope: 344.4266, sigma: 15.78127, x: 15.25468 },
  "Qinghai":        { intercept: 1.427224,  slope: 461.8694, sigma: 4.788465, x: 22.45286 },
  "Jilin":          { intercept: 1.349814,  slope: 480.1877, sigma: 20.19012, x: 29.6993 },
  "Liaoning":       { intercept: 0.9062255, slope: 370.3769, sigma: 40.79853, x: 22.08256 },
  "Shaanxi":        { intercept: 0.3336013, slope: 298.8889, sigma: 5.547025, x: 30.49408 },
  "Guangdong":      { intercept: 1.134459,  slope: 155.2219, sigma: 47.52580, x: 59.77705 },
  "Chongqing":      { intercept: 0.6776533, slope: 401.4827, sigma: 8.692573, x: 103.7286 },
  "Anhui":          { intercept: 0.3809696, slope: 348.9635, sigma: 3.740448, x: 52.86329 }
};
const state = new Map();

/* ---------- HELPERS ---------- */
const $ = id => document.getElementById(id);
const linspace = (a,b,n)=>Array.from({length:n},(_,i)=>a+i*(b-a)/(n-1));

function ensureState(){
  PROVINCES.forEach(p=>{
    if(!state.has(p)) state.set(p,{...DEFAULT});
  });
}

/* ---------- TABLE ---------- */
function buildTable(){
  const tbody = $("paramBody");
  tbody.innerHTML = "";

  PROVINCES.forEach(p=>{
    const v = state.get(p);
    const id = p.replace(/\s+/g,"-").toLowerCase();

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${p}</b></td>
      <td class="num"><input type="number" step="0.1" value="${v.intercept}" data-p="${p}" data-k="intercept"></td>
      <td class="num"><input type="number" step="0.1" value="${v.slope}" data-p="${p}" data-k="slope"></td>
      <td class="num"><input type="number" step="0.1" value="${v.sigma}" data-p="${p}" data-k="sigma"></td>
      <td class="num"><input type="number" step="0.1" value="${v.x}" data-p="${p}" data-k="x"></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.oninput = e=>{
    const el = e.target;
    if(!el.dataset.p) return;
    const v = state.get(el.dataset.p);
    v[el.dataset.k] = Number(el.value);
    renderProvince(el.dataset.p);
    if($("sameY").value==="common") renderAll();
  };
}

/* ---------- PLOTS ---------- */
function computeCommonY(){
  const amax = +$("amax").value;
  const npts = +$("npts").value;
  let ymin=Infinity, ymax=-Infinity;

  PROVINCES.forEach(p=>{
    const v = state.get(p);
    linspace(0,amax,npts).forEach(x=>{
      const y = v.intercept + v.slope*x;
      ymin=Math.min(ymin,y);
      ymax=Math.max(ymax,y);
    });
  });
  const pad = 0.05*(ymax-ymin||1);
  return [ymin-pad,ymax+pad];
}

function renderProvince(p, commonY=null){
  const v = state.get(p);
  const id = p.replace(/\s+/g,"-").toLowerCase();
  const amax = +$("amax").value;
  const npts = +$("npts").value;

  const x = linspace(0,amax,npts);
  const y = x.map(xx=>v.intercept+v.slope*xx);

  document.getElementById(`meta-${id}`).textContent =
    `a=${v.intercept}, b=${v.slope}, σ=${v.sigma}, x=${v.x}`;

  const layout = {
    margin:{t:18,l:44,r:10,b:34},
    xaxis:{title:"Abatement", tickfont:{size:11}},
    yaxis:{title:"MAC", tickfont:{size:11}},
    showlegend:false
  };
  if(commonY) layout.yaxis.range = commonY;

  Plotly.newPlot(`plot-${id}`,[{x,y,type:"scatter",mode:"lines",line:{width:2}}],layout,
    {responsive:true, displayModeBar:false});
}

function renderAll(){
  $("plots").style.gridTemplateColumns =
    `repeat(${$("cols").value}, minmax(220px,1fr))`;

  const commonY = $("sameY").value==="common" ? computeCommonY() : null;
  PROVINCES.forEach(p=>renderProvince(p, commonY));
}

/* ---------- INIT ---------- */
function ensureState(){
  PROVINCES.forEach(p=>{
    if (!state.has(p)) {
      const d = DEFAULTS[p] || { intercept:0, slope:1, sigma:5, x:0 };
      state.set(p, { ...d });
    }
  });
}
buildTable();

// build plot cards
$("plots").innerHTML = "";
PROVINCES.forEach(p=>{
  const id = p.replace(/\s+/g,"-").toLowerCase();
  const div = document.createElement("div");
  div.className="plot-card";
  div.innerHTML = `
    <div class="plot-title">${p}</div>
    <div class="plot-meta" id="meta-${id}"></div>
    <div id="plot-${id}" class="plot"></div>
  `;
  $("plots").appendChild(div);
});

renderAll();

function computeWelfare() {

  const slopes = [];
  const sigmas = [];
  const xs = [];

  for (const prov of PROVINCES) {
    const v = state.get(prov);
    const c = v.slope;
    const s = v.sigma;
    const x = v.x;

    if (c > 0 && Number.isFinite(c)) {
      slopes.push(c);
      sigmas.push(Number.isFinite(s) ? s : 0);
      xs.push(Number.isFinite(x) ? x : 0);
    }
  }

  const N = slopes.length;
  if (N === 0) {
    $("wResult").textContent =
      "Cannot compute: no province with positive slope.";
    Plotly.purge("wBar");
    return;
  }

  // weights
  const invC = slopes.map(c => 1 / c);
  const S = invC.reduce((a,b)=>a+b,0);
  const w = invC.map(v => v / S);

  // --- Plan welfare ---
  let Vtheta = 0;
  for (let i = 0; i < N; i++) {
    Vtheta += w[i] * (1 - w[i]) * sigmas[i] * sigmas[i];
  }
  const deltaWPlan = 0.5 * S * Vtheta;

  // --- Market welfare ---
  let xbar = 0;
  for (let i = 0; i < N; i++) xbar += w[i] * xs[i];

  let Dx = 0;
  for (let i = 0; i < N; i++) {
    const d = xs[i] - xbar;
    Dx += w[i] * d * d;
  }
  const deltaWMarket = 0.5 * S * Dx;

  // --- bar chart ---
  Plotly.newPlot("wBar", [{
    x: ["Plan","Market"],
    y: [deltaWPlan, deltaWMarket],
    type: "bar",
    text: [deltaWPlan, deltaWMarket].map(v => v.toFixed(3)),
    textposition: "outside"
  }], {
    margin:{t:30,r:10,b:40,l:60},
    yaxis:{title:"Welfare loss"},
  }, {displayModeBar:false});

  // --- display text summary ---
  $("wResult").innerHTML =
    `Provinces used: ${N}<br>` +
    `S = ${S.toFixed(4)}, V\u03B8 = ${Vtheta.toFixed(4)}, ` +
    `D<sub>x</sub> = ${Dx.toFixed(4)}<br>` +
    `ΔW<sup>Plan</sup> ≈ <b>${deltaWPlan.toFixed(4)}</b>, ` +
    `ΔW<sup>Market</sup> ≈ <b>${deltaWMarket.toFixed(4)}</b>`;
}

/* ---------- EVENTS ---------- */
["amax","npts","cols","sameY"].forEach(id=>{
  $(id).addEventListener("change", renderAll);
});
$("renderAll").onclick = renderAll;
$("resetAll").onclick = ()=>{
  state.clear();
  ensureState();
  buildTable();
  renderAll();
};

$("calcW").onclick = computeWelfare;

</script>





</body>
</html>